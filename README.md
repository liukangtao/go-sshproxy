# Proxy - 智能网络代理服务器

[![Go Report Card](https://goreportcard.com/badge/github.com/yourusername/proxy)](https://goreportcard.com/report/github.com/yourusername/proxy)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)

Proxy 是一个用 Go 语言编写的高性能智能网络代理服务器，支持 SOCKS5 和 HTTP/HTTPS 协议。它能够根据目标地址和网络状况智能选择最佳路由方式（SSH 隧道或直连），并通过连接池管理提高处理效率。

## 功能特性

- **多协议支持**：同时支持 SOCKS5 和 HTTP/HTTPS 代理协议
- **智能路由选择**：根据目标地址和网络状况智能选择最佳路由方式
- **SSH 隧道支持**：可通过 SSH 隧道转发网络请求，突破网络限制
- **连接池管理**：高效的 SSH 连接池管理，避免频繁创建和销毁连接
- **路由缓存机制**：缓存目标地址的最佳路由方式，提高处理速度
- **并发控制**：限制最大并发连接数，防止资源耗尽
- **健康检查**：定期检查连接健康状态，确保连接有效性
- **日志记录**：可选的日志记录功能，便于监控和调试

## 技术架构

```
+---------------------+
|   客户端请求处理    |
| SOCKS5/HTTP代理服务 |
+----------+----------+
           |
+----------v----------+
|   智能路由选择器    |
| (SSH隧道 vs 直连)   |
+----------+----------+
           |
+----------v----------+
|     SSH连接池       |
|  (连接复用管理)     |
+----------+----------+
           |
+----------v----------+
|    目标服务器连接    |
+---------------------+
```


## 安装

### 环境要求

- Go 1.24.0 或更高版本
- SSH 服务器（用于 SSH 隧道转发）

### 构建

```bash
# 克隆项目
git clone https://github.com/yourusername/proxy.git
cd proxy

# 构建
go build

# 运行
./proxy
```


## 使用方法

### 基本用法

```bash
# 使用默认配置启动
./proxy

# 自定义配置启动
./proxy --sshUser myuser --sshHost 192.168.1.100 --port 22 --socks5 1080 --http 8080
```


### 命令行参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| --sshUser | root | SSH 用户名 |
| --sshHost | 23.95.214.100 | SSH 主机地址 |
| --port | 22 | SSH 端口 |
| --socks5 | 6111 | SOCKS5 代理监听端口 |
| --http | 8880 | HTTP 代理监听端口 |
| --log | false | 是否将日志写入文件 |
| --sshPasswd | Thisismyhost | SSH 密码 |
| --foreground | false | 是否在前台运行 |

### 使用示例

#### 浏览器代理设置

1. **SOCKS5 代理**：
   - 地址：localhost
   - 端口：6111

2. **HTTP 代理**：
   - 地址：localhost
   - 端口：8880

#### 命令行工具使用

```bash
# 使用 curl 通过 HTTP 代理访问网站
curl --proxy http://localhost:8880 https://www.google.com

# 使用 curl 通过 SOCKS5 代理访问网站
curl --proxy socks5://localhost:6111 https://www.google.com
```


## 配置说明

### 系统参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| maxConcurrentConnections | 1000 | 最大并发连接数 |
| maxCacheSize | 10000 | 最大缓存条目数 |
| connectionTimeout | 60秒 | 连接超时时间 |
| sshTimeout | 30秒 | SSH 连接超时时间 |
| routeTimeout | 10秒 | 路由选择超时时间 |

## 性能优化

### 连接复用
通过 SSH 连接池实现连接复用，避免频繁创建和销毁连接，显著提高处理效率。

### 智能路由
通过并发测试不同路由方式的响应时间，选择最优路径，提升用户体验。

### 缓存机制
使用路由缓存减少重复的路由选择过程，提高处理速度。

### 资源控制
通过并发连接数限制和连接池大小控制，防止系统资源耗尽。

## 架构设计

### 模块化设计

项目采用模块化设计，各个功能模块职责清晰：

- [main.go]   - 主程序入口
- [config.go] - 配置管理
- [types.go]  - 数据类型定义
- [pool.go]   - SSH 连接池管理
- [route.go]  - 路由选择和缓存管理
- [socks5.go] - SOCKS5 协议处理
- [http.go]   - HTTP/HTTPS 协议处理
- [proxy.go]  - 代理服务核心功能

### 连接池机制

SSH 连接池通过以下机制提高性能：

1. **连接复用**：多个请求可以共享同一个 SSH 连接
2. **健康检查**：定期检查连接有效性
3. **空闲清理**：释放长时间未使用的连接
4. **容量控制**：限制连接池最大大小

### 智能路由选择

路由选择通过以下步骤实现：

1. **缓存优先**：首先检查路由缓存
2. **并发测试**：同时测试 SSH 隧道和直连方式
3. **性能优化**：选择最快响应的连接方式
4. **缓存更新**：更新路由缓存以供后续请求使用

## 监控与日志

### 日志记录
支持将路由结果记录到日志文件中：

```bash
./proxy -log
```


日志格式示例：
```
[2025-03-14 10:32:27] 目标:www.google.com:443 方式:SSH 耗时:226.971086ms
[2025-03-14 10:32:23] 目标:www.tita.net:443 方式:Direct 耗时:77.981082ms
```


### 缓存监控
- 定期清理过期缓存（默认 30 分钟）
- 自动处理超限缓存

### 连接监控
- 定期清理空闲连接（默认 1 小时）
- 监控连接池状态

## 安全考虑

### SSH 安全
- 支持密码认证方式
- 可扩展支持私钥认证
- 连接超时控制

### 访问控制
- 通过监听端口控制访问
- 可扩展实现 IP 白名单等访问控制机制

## 部署与运维

### 部署方式
- 直接部署 Go 编译生成的二进制文件
- 支持守护进程模式运行

### 运维建议
1. 定期检查日志文件大小
2. 监控系统资源使用情况
3. 根据实际使用情况调整配置参数

### 性能调优
1. 根据实际负载调整连接池大小
2. 合理设置缓存大小和清理周期
3. 根据网络环境调整超时参数

## 贡献

欢迎提交 Issue 和 Pull Request 来改进这个项目。

### 开发环境设置

```bash
# 克隆项目
git clone https://github.com/yourusername/proxy.git
cd proxy

# 运行测试
go test ./...

# 构建
go build
```

**注意**：本项目仅供学习和研究使用，请遵守相关法律法规，不要用于非法用途。
